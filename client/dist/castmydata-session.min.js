!function(t,e){"use strict";"object"==typeof exports&&"undefined"!=typeof module?e(exports,t):e(t.CastMyData=t.CastMyData||{},t)}(this,function(t,e){"use strict";function n(){this._events={}}function o(t){var e=this;this._storage=s,this._events={};var n=this._socket=("undefined"!=typeof io?io:require("socket.io-client"))(t+"?path=session",{multiplex:!1});n.on("session:update",function(t){e.data=t,e.save(),e.emit("update")}),n.on("reconnect",function(){e.load()}),this.load()}var s,i={};if("object"==typeof t&&"undefined"!=typeof module){var r=require("node-localstorage").LocalStorage;s=new r("./scratch")}else s=window.localStorage;var a=e.document||{cookie:""};!function(t){for(var e=[],n=0;n<=15;n++)e[n]=n.toString(16);var o=function(){for(var t="",n=1;n<=36;n++)t+=9===n||14===n||19===n||24===n?"-":15===n?4:20===n?e[4*Math.random()|8]:e[15*Math.random()|0];return t};t.uuid=o}(i),function(t){var e={set:function(t,e,n,o,s){var i=new Date,r="",c=typeof e,u="",f="";if(o=o||"/",n&&(i.setTime(i.getTime()+24*n*60*60*1e3),r="; expires="+i.toUTCString()),"object"===c&&"undefined"!==c){if(!("JSON"in window))throw"Bummer, your browser doesn't support JSON parsing.";u=encodeURIComponent(JSON.stringify({v:e}))}else u=encodeURIComponent(e);s&&(f="; secure"),a.cookie=t+"="+u+r+"; path="+o+f},get:function(t){for(var e=t+"=",n=a.cookie.split(";"),o="",s="",i={},r=0;r<n.length;r++){for(var c=n[r];" "==c.charAt(0);)c=c.substring(1,c.length);if(0===c.indexOf(e)){if(o=decodeURIComponent(c.substring(e.length,c.length)),s=o.substring(0,1),"{"==s)try{if(i=JSON.parse(o),"v"in i)return i.v}catch(u){return o}if("undefined"==o)return;return o}}return null},remove:function(t){this.set(t,"",-1)},increment:function(t,e){var n=this.get(t)||0;this.set(t,parseInt(n,10)+1,e)},decrement:function(t,e){var n=this.get(t)||0;this.set(t,parseInt(n,10)-1,e)}};t.cookies=e}(i),function(t){function e(t){return t.replace(/\\\./g,"ï¿¿").split(".").map(function(t){return t.replace(/\uffff/g,".")})}var n=i.go={};n.get=function(t,n,o){"string"==typeof n&&(n=e(n));for(var s;"object"==typeof t&&t&&n.length;)s=n.shift(),s in t||!o||(t[s]={}),t=t[s];return t},n.set=function(t,o,s){o=e(o);var i=o.pop();if(t=n.get(t,o,!0),t&&"object"==typeof t)return t[i]=s},n.exists=function(t,o){o=e(o);var s=o.pop();return t=n.get(t,o),"object"==typeof t&&t&&s in t}}(i),n.prototype={on:function(t,e){var n=this;return t.split(/\s+/g).forEach(function(t){n._events[t]||(n._events[t]=[]),n._events[t].push(e)}),this},off:function(t,e){var n=this;return t.split(/\s+/g).forEach(function(t){var e=n._events[t];e&&(n._events[t]=n._events[t].filter(function(t){return t!==t}))}),this},once:function(t,e){var n=this;return t.split(/\s+/g).forEach(function(t){n._events[t]||(n._events[t]=[]),e._callOnce=!0,n._events[t].push(e)}),this},emit:function(t,e,n){var o=this;n=n||this;var s=this._events[t]||(this._events[t]=[]);return s.forEach(function(s){return s._callOnce?(delete s._callOnce,s.call(n,e),o.off(t,s),o):void s.call(n,e)}),this}},i.cookies.get("cmd.sid")||i.cookies.set("cmd.sid",i.uuid(),3650),o.prototype=Object.create(n.prototype),o.prototype.load=function(){var t=this._storage.getItem("castmydata-session")||"{}";this.data=JSON.parse(t),this.emit("load"),this._socket.emit("session:load")},o.prototype.set=function(t,e){function n(t){o.emit("set:error",t),o.data=s,o.emit("update")}var o=this,s=JSON.parse(JSON.stringify(this.data));i.go.set(this.data,t,e),this.emit("update"),this._socket.once("session:set:"+t+":deny",n),this._socket.once("session:set:"+t+":ok",function(){o._socket.off("session:set:"+t+":deny",n)}),this._socket.emit("session:set",{path:t,value:e})},o.prototype.save=function(){var t=this.data||{};this._storage.setItem("castmydata-session",JSON.stringify(t)),this.emit("save")},t.Session=o});