!function(t,e){"use strict";"object"==typeof exports&&"undefined"!=typeof module?e(exports,t):e(t.CastMyData=t.CastMyData||{},t)}(this,function(t,e){"use strict";function s(){this._events={}}function n(t){var e=this;this._storage=o,this._events={};var s=this._socket=("undefined"!=typeof io?io:require("socket.io-client"))(t+"?path=session",{multiplex:!1});s.on("session:set",function(t){e.data=t,e.save(),e.emit("set")}),s.on("session:delete",function(t){e.data=t,e.save(),e.emit("delete")}),s.on("session:clear",function(t){e.data=t,e.save(),e.emit("clear")}),s.on("reconnect",function(){e.load()}),this.load()}var o,i={};if("object"==typeof t&&"undefined"!=typeof module){var r=require("node-localstorage").LocalStorage;o=new r("./scratch")}else o=window.localStorage;var a=e.document||{cookie:""};!function(t){for(var e=[],s=0;s<=15;s++)e[s]=s.toString(16);var n=function(){for(var t="",s=1;s<=36;s++)t+=9===s||14===s||19===s||24===s?"-":15===s?4:20===s?e[4*Math.random()|8]:e[15*Math.random()|0];return t};t.uuid=n}(i),function(t){var e={set:function(t,e,s,n,o){var i=new Date,r="",c=typeof e,f="",u="";if(n=n||"/",s&&(i.setTime(i.getTime()+24*s*60*60*1e3),r="; expires="+i.toUTCString()),"object"===c&&"undefined"!==c){if(!("JSON"in window))throw"Bummer, your browser doesn't support JSON parsing.";f=encodeURIComponent(JSON.stringify({v:e}))}else f=encodeURIComponent(e);o&&(u="; secure"),a.cookie=t+"="+f+r+"; path="+n+u},get:function(t){for(var e=t+"=",s=a.cookie.split(";"),n="",o="",i={},r=0;r<s.length;r++){for(var c=s[r];" "==c.charAt(0);)c=c.substring(1,c.length);if(0===c.indexOf(e)){if(n=decodeURIComponent(c.substring(e.length,c.length)),o=n.substring(0,1),"{"==o)try{if(i=JSON.parse(n),"v"in i)return i.v}catch(f){return n}if("undefined"==n)return;return n}}return null},remove:function(t){this.set(t,"",-1)},increment:function(t,e){var s=this.get(t)||0;this.set(t,parseInt(s,10)+1,e)},decrement:function(t,e){var s=this.get(t)||0;this.set(t,parseInt(s,10)-1,e)}};t.cookies=e}(i),function(t){function e(t){return t.replace(/\\\./g,"ï¿¿").split(".").map(function(t){return t.replace(/\uffff/g,".")})}var s=t.go={};s.get=function(t,s,n){"string"==typeof s&&(s=e(s));for(var o;"object"==typeof t&&t&&s.length;)o=s.shift(),o in t||!n||(t[o]={}),t=t[o];return t},s.set=function(t,n,o){n=e(n);var i=n.pop();if(t=s.get(t,n,!0),t&&"object"==typeof t)return t[i]=o},s.unset=function(t,e){if(t.hasOwnProperty(e)&&delete t[e],s.get(t,e)){for(var n=e.split("."),o=n.pop();n.length&&"\\"===n[n.length-1].slice(-1);)o=n.pop().slice(0,-1)+"."+o;for(;n.length;)t=t[e=n.shift()];return delete t[o]}},s.exists=function(t,n){n=e(n);var o=n.pop();return t=s.get(t,n),"object"==typeof t&&t&&o in t}}(i),s.prototype={on:function(t,e){var s=this;return t.split(/\s+/g).forEach(function(t){s._events[t]||(s._events[t]=[]),s._events[t].push(e)}),this},off:function(t,e){var s=this;return t.split(/\s+/g).forEach(function(t){var e=s._events[t];e&&(s._events[t]=s._events[t].filter(function(t){return t!==t}))}),this},once:function(t,e){var s=this;return t.split(/\s+/g).forEach(function(t){s._events[t]||(s._events[t]=[]),e._callOnce=!0,s._events[t].push(e)}),this},emit:function(t,e,s){var n=this;s=s||this;var o=this._events[t]||(this._events[t]=[]);return o.forEach(function(o){return o._callOnce?(delete o._callOnce,o.call(s,e,t),n.off(t,o),n):void o.call(s,e,t)}),this}},i.cookies.get("cmd.sid")||i.cookies.set("cmd.sid",i.uuid(),3650),n.prototype=Object.create(s.prototype),n.prototype.load=function(){var t=this._storage.getItem("castmydata-session")||"{}";this.data=JSON.parse(t),this.emit("load"),this._socket.emit("session:load")},n.prototype.set=function(t,e){function s(t){n.data=o,n.emit("set:error",t)}var n=this,o=JSON.parse(JSON.stringify(this.data));i.go.set(this.data,t,e),this.emit("set"),this._socket.once("session:set:"+t+":deny",s),this._socket.once("session:set:"+t+":ok",function(){n._socket.off("session:set:"+t+":deny",s)}),this._socket.emit("session:set",{path:t,value:e})},n.prototype["delete"]=function(t){function e(t){s.data=n,s.emit("delete:error",t)}var s=this;if(!i.go.exists(this.data,t))return this.emit("delete:error","Path "+t+" does not exist");var n=JSON.parse(JSON.stringify(this.data));i.go.unset(this.data,t),this.emit("delete"),this._socket.once("session:delete:"+t+":deny",e),this._socket.once("session:delete:"+t+":ok",function(){s._socket.off("session:delete:"+t+":deny",e)}),this._socket.emit("session:delete",{path:t})},n.prototype.clear=function(){function t(t){e.data=s,e.emit("clear:error",t)}var e=this,s=JSON.parse(JSON.stringify(this.data));this.data={},this.emit("clear"),this._socket.once("session:clear:deny",t),this._socket.once("session:clear:ok",function(){e._socket.off("session:clear:deny",t)}),this._socket.emit("session:clear")},n.prototype.save=function(){var t=this.data||{};this._storage.setItem("castmydata-session",JSON.stringify(t)),this.emit("save")},t.Session=n});